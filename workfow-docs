#!/bin/bash

workflow_file=$1

generate_inputs() {
    echo "## inputs"
    echo
    echo "|name|description|default|required|type|"
    echo "|-|-|-|-|:-|"

    for var_name in $(yq '.on.workflow_call.inputs | keys' < $workflow_file); do
        if [[ "$var_name" == '[' || "$var_name" == ']' ]]; then continue; fi
        var="${var_name/,/}"
        var="${var//\"/}"
        description=$(yq ".on.workflow_call.inputs[${var_name/,/}].description" < $workflow_file)
        default=$(yq ".on.workflow_call.inputs[${var_name/,/}].default" < $workflow_file)
        required=$(yq ".on.workflow_call.inputs[${var_name/,/}].required" < $workflow_file)
        type=$(yq ".on.workflow_call.inputs[${var_name/,/}].type" < $workflow_file)

        if [[ "${description}" == "null" ]]; then description="n/a"; fi
        if [[ "${default}" == "null" ]]; then default="-"; fi
        if [[ "${required}" == "null" ]]; then required="false"; fi
        if [[ "${type}" == "null" ]]; then type="string"; fi

        echo "| \`$var\` | $description | \`${default//\"/}\` | $required |$type|"
    done
    echo
}

generate_secrets() {
    echo "## secrets"
    echo
    echo "|name|description|required|"
    echo "|-|-|-|"

    for var_name in $(yq '.on.workflow_call.secrets | keys' < $workflow_file); do
        if [[ "$var_name" == '[' || "$var_name" == ']' ]]; then continue; fi
        var="${var_name/,/}"
        var="${var//\"/}"
        description=$(yq ".on.workflow_call.secrets[${var_name/,/}].description" < $workflow_file)
        required=$(yq ".on.workflow_call.secrets[${var_name/,/}].required" < $workflow_file)

        if [[ "${description}" == "null" ]]; then description="n/a"; fi
        if [[ "${required}" == "null" ]]; then required="false"; fi

        echo "| \`$var\` | $description | $required |"
    done
    echo
}

if [[ -z "$workflow_file" ]]; then
    echo "no workflow_file given."
    exit 1
fi

main() {
    local generate="${1}"

    case "$generate" in
        "inputs"|"input"|"i")
            generate_inputs
        ;;
        "secrets"|"secret"|"s")
            generate_secrets
        ;;
        *)
            generate_inputs
            generate_secrets
        ;;
    esac

}

main "${2:-all}"
