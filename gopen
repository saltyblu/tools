#!/bin/bash

_BROWSER=xdg-open

get_os() {
    if uname -a | grep Darwin &>/dev/null; then
        _BROWSER=open
    fi
}

usage() {
    echo "$0 <help|edit|pipe|merge|setci|set_repo>"
    echo "opens the weburl of pwd git in browser"
    echo "Optional:"
    echo "    edit:      opens edit page of git"
    echo "    pipe:      opens pipeline page of git"
    echo "    merge:     opens merge request of git"
    echo "    setci:     opens git ci_cd settings "
    echo "    set_repo:  opens git repository settings"
    echo "    help || ?: shows this usage"
    echo "Opts:"
    echo "    -h,--help,-? shows this usage"
    exit 1
}

if [ -n "$1" ]; then
    case $1 in
        "edit"|"pipelines"|"merge_request")
            GL_URLPREFIX="/$1"
            ;;
        "pipe"|"cicd"|"actions")
            GL_URLPREFIX="/pipelines"
            GH_URLPREFIX="/actions"
            ;;
        "merge"|"pulls"|"pull")
            GL_URLPREFIX="/merge_requests"
            GH_URLPREFIX="/pull"
            ;;
        "set_ci"|"setci")
            GL_URLPREFIX="/settings/ci_cd"
            GH_URLPREFIX="settings/actions"
            ;;
        "set_repo"|"setrepo"|"setr")
            GL_URLPREFIX="/settings/repository"
            GH_URLPREFIX="/settings"
            ;;
        "help"|"?"|"--help"|"-h"|"-?")
            usage
            ;;
        *)
            GH_URLPREFIX=""
            GL_URLPREFIX=""
            ;;
    esac
fi

get_os

if git remote &>/dev/null ; then
  GITLAB_URL=$(git config --get remote.origin.url)
  GIT_URL=${GITLAB_URL%\.git}
  if [[ ! "$GIT_URL" =~ ^http* ]]; then
    GIT_URL=${GIT_URL#git@}
    GIT_URL=${GIT_URL/:/\/}
  fi
  SUBURL=${GIT_URL/*\//}
  if [ -n "$SUBURL" ] && [[ "$GITLAB_URL" =~ "gitlab" ]]; then
    URL="https://${GIT_URL}${GL_URLPREFIX}"
  elif [ -n "$SUBURL" ] && [[ "$GITLAB_URL" =~ "github" ]]; then
    URL="https://${GIT_URL}${GH_URLPREFIX}"
  else
    URL="https://${GIT_URL}"
  fi
else
  echo "$PWD - Don't seems to be a git"
  exit 1
fi

$_BROWSER "$URL" 2>/dev/null &
